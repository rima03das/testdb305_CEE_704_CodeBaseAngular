import { Injectable } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../models/api-data/api-data.service";
export class SidemenuUtil {
    apiDataService;
    globalMenu = [];
    sidemenuBlock;
    sidemenuBlockOn = false;
    blockSetter = false;
    constructor(apiDataService) {
        this.apiDataService = apiDataService;
    }
    setSidemenuBlockStateOnDataEmit(res, sideBlockData, stepId) {
        if (sideBlockData) {
            for (const sidemenuBlockId of sideBlockData) {
                if (sidemenuBlockId.step_id && sidemenuBlockId.step_id.includes(stepId)) {
                    // console.log("sidemenuData>>>>>", stepId,sidemenuBlockId.step_id[0]);
                    // }
                    // if(this.sidemenuBlockOn == false){
                    this.globalMenu = sidemenuBlockId.submenu;
                    this.checkmenuContainsDyanmicContent(sidemenuBlockId.submenu);
                    // }
                    sidemenuBlockId.submenu = this.globalMenu;
                    this.sidemenuBlock = sidemenuBlockId;
                    this.sidemenuBlockOn = false;
                    let sideBlockDataResult = {
                        sidemenuBlock: this.sidemenuBlock,
                        sidemenuBlockOn: this.sidemenuBlockOn
                    };
                    return sideBlockDataResult;
                }
            }
        }
    }
    checkmenuContainsDyanmicContent(menu) {
        for (let i = 0; i < menu.length; i++) {
            if (menu[i].response_api_key && menu[i].response_api_key !== "") {
                this.createnewMenu(menu[i], menu[i].level, this.globalMenu);
            }
            if (menu[i].submenu && menu[i].submenu?.length > 0) {
                this.checkmenuContainsDyanmicContent(menu[i].submenu);
            }
        }
    }
    addyanmicContent(arrayAdd, text, level, globalMenu) {
        for (let i = 0; i < globalMenu?.length; i++) {
            if (globalMenu[i].response_api_key && globalMenu[i].response_api_key !== "") {
                if (globalMenu[i].linkText == text && globalMenu[i].level == level) {
                    globalMenu.splice(i, 1, ...arrayAdd);
                    break;
                }
            }
            if (globalMenu[i].submenu && globalMenu[i].submenu?.length > 0) {
                this.addyanmicContent(arrayAdd, text, level, globalMenu[i].submenu);
            }
        }
        this.globalMenu = globalMenu;
    }
    createnewMenu(menu, level, gm) {
        if (menu && menu.response_api_key) {
            let newArray = [];
            let responseKeys = menu.response_api_key.split("||");
            this.getCurrentParameterValue(responseKeys, 1);
            let parameterValue = this.blockSetter == true ? 1 : 0;
            let apiData = this.apiDataService.getApiDataByHandler(responseKeys[parameterValue].split('##')[0].trim());
            if (responseKeys[parameterValue].includes('[*]') && apiData) {
                const regex = responseKeys[parameterValue].split('[*]').join('\\[\\d+\\]');
                let counter = 0;
                const subMenuStatic = menu.submenu;
                for (const dataKey of Object.keys(apiData.value)) {
                    let newMenu = {};
                    const result = dataKey.match(new RegExp(regex));
                    if (result && apiData.value[dataKey] != null) {
                        let getlevel = this.getLevelClass(menu.level, menu.attchedmenuClass, counter, "", 1);
                        let getStatic = this.staticMenuAfterDynamic(subMenuStatic, getlevel, gm);
                        let clonedStatic = JSON.parse(JSON.stringify(getStatic));
                        newMenu.linkText = apiData.value[dataKey];
                        newMenu.menu = menu.menu;
                        // newMenu.attchedmenuClass =  getlevel;
                        //newMenu.attchedmenuClass =  menu.attchedmenuClass;
                        newMenu.attchedmenuClass = menu.attchedmenuClass + "_" + (counter + 1).toString();
                        newMenu.attachtoStep = menu.attachtoStep;
                        newMenu.menuclass = menu.menuclass;
                        newMenu.response_api_key = "";
                        newMenu.submenu = menu.submenu?.length > 0 ? clonedStatic : [];
                        newMenu.level = menu.level,
                            newMenu.menu_condition = menu.menu_condition;
                        newArray.push(newMenu);
                        counter++;
                    }
                }
                this.addyanmicContent(newArray, menu.linkText, level, gm);
            }
        }
    }
    getCurrentParameterValue(responseKeys, i) {
        if (responseKeys[i]) {
            let apiData = this.apiDataService.getApiDataByHandler(responseKeys[i].split('##')[0].trim());
            if (responseKeys[i].includes('[*]') && apiData) {
                const regex = responseKeys[i].split('[*]').join('\\[\\d+\\]');
                for (const dataKey of Object.keys(apiData.value)) {
                    const result = dataKey.match(new RegExp(regex));
                    if (result && apiData.value[dataKey] != null) {
                        this.blockSetter = true;
                    }
                }
            }
        }
    }
    staticMenuAfterDynamic(menu, parentPosition, gm) {
        menu.map((x, i) => {
            x.attchedmenuClass = this.getLevelClass(x.level, x.attchedmenuClass, i, parentPosition, 2);
            if (x.response_api_key && x.response_api_key !== "") {
                this.createnewMenu(x, x.level, gm);
            }
        });
        return menu;
    }
    getLevelClass(menuLevel, menuPosition, counter, parentPosition, box) {
        let parentPositionAdd;
        let contentValue = "dy";
        if (parentPosition != "") {
            const parentparts = parentPosition?.split('_');
            parentPositionAdd = Number(parentparts[parentparts.length - 1]);
        }
        const parts = menuPosition?.split('_');
        let lastNumber = box == 1 ? Number(parts[parts.length - 1]) + Number(counter) : Number(counter);
        let finalmenulevel = parentPositionAdd ? this.createMenuStringRecursive(menuLevel) + "_" + contentValue + "_" + parentPositionAdd + "_" + lastNumber : this.createMenuStringRecursive(menuLevel) + "_" + contentValue + "_" + lastNumber;
        return finalmenulevel;
    }
    createMenuStringRecursive(level) {
        if (level === 1) {
            return 'level1';
        }
        else {
            return this.createMenuStringRecursive(level - 1) + `_level${level}`;
        }
    }
    static ɵfac = function SidemenuUtil_Factory(t) { return new (t || SidemenuUtil)(i0.ɵɵinject(i1.ApiDataService)); };
    static ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: SidemenuUtil, factory: SidemenuUtil.ɵfac, providedIn: 'root' // The service is provided at the root level
     });
}
(() => { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(SidemenuUtil, [{
        type: Injectable,
        args: [{
                providedIn: 'root' // The service is provided at the root level
            }]
    }], () => [{ type: i1.ApiDataService }], null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lkZW1lbnUtdXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL0FuZ3VsYXItMTcvRVNGLUFuZ3VsYXItV0ZFLUxpYnJhcnkvcHJvamVjdHMvbmctY2VlLWNvcmUvc3JjL2xpYi91dGlscy9zaWRlbWVudS11dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7OztBQU0zQyxNQUFNLE9BQU8sWUFBWTtJQUtEO0lBSnBCLFVBQVUsR0FBRyxFQUFFLENBQUM7SUFDaEIsYUFBYSxDQUFNO0lBQ25CLGVBQWUsR0FBRyxLQUFLLENBQUM7SUFDeEIsV0FBVyxHQUFHLEtBQUssQ0FBQztJQUNwQixZQUFvQixjQUE4QjtRQUE5QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7SUFBSSxDQUFDO0lBRXZELCtCQUErQixDQUFDLEdBQUcsRUFBRSxhQUFhLEVBQUMsTUFBTTtRQUNyRCxJQUFJLGFBQWEsRUFBRTtZQUNmLEtBQUssTUFBTSxlQUFlLElBQUksYUFBYSxFQUFFO2dCQUN6QyxJQUFJLGVBQWUsQ0FBQyxPQUFPLElBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3JFLHVFQUF1RTtvQkFDM0UsSUFBSTtvQkFDQSxxQ0FBcUM7b0JBQ2pDLElBQUksQ0FBQyxVQUFVLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQztvQkFDMUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDbEUsSUFBSTtvQkFDSixlQUFlLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7b0JBQzFDLElBQUksQ0FBQyxhQUFhLEdBQUcsZUFBZSxDQUFDO29CQUNyQyxJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztvQkFDN0IsSUFBSSxtQkFBbUIsR0FBRzt3QkFDdEIsYUFB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LFVBQVUsRUFBRSxNQUFNLENBQUMsNENBQTRDO2FBQ2hFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBcGlEYXRhU2VydmljZSB9IGZyb20gJy4uL21vZGVscy9hcGktZGF0YS9hcGktZGF0YS5zZXJ2aWNlJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcgLy8gVGhlIHNlcnZpY2UgaXMgcHJvdmlkZWQgYXQgdGhlIHJvb3QgbGV2ZWxcclxufSlcclxuZXhwb3J0IGNsYXNzIFNpZGVtZW51VXRpbCB7XHJcbiAgICBnbG9iYWxNZW51ID0gW107XHJcbiAgICBzaWRlbWVudUJsb2NrOiBhbnk7XHJcbiAgICBzaWRlbWVudUJsb2NrT24gPSBmYWxzZTtcclxuICAgIGJsb2NrU2V0dGVyID0gZmFsc2U7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwaURhdGFTZXJ2aWNlOiBBcGlEYXRhU2VydmljZSkgeyB9XHJcblxyXG4gICAgc2V0U2lkZW1lbnVCbG9ja1N0YXRlT25EYXRhRW1pdChyZXMsIHNpZGVCbG9ja0RhdGEsc3RlcElkKSB7XHJcbiAgICAgICAgaWYgKHNpZGVCbG9ja0RhdGEpIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBzaWRlbWVudUJsb2NrSWQgb2Ygc2lkZUJsb2NrRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNpZGVtZW51QmxvY2tJZC5zdGVwX2lkICYmIHNpZGVtZW51QmxvY2tJZC5zdGVwX2lkLmluY2x1ZGVzKHN0ZXBJZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcInNpZGVtZW51RGF0YT4+Pj4+XCIsIHN0ZXBJZCxzaWRlbWVudUJsb2NrSWQuc3RlcF9pZFswXSk7XHJcbiAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaWYodGhpcy5zaWRlbWVudUJsb2NrT24gPT0gZmFsc2Upe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbE1lbnUgPSBzaWRlbWVudUJsb2NrSWQuc3VibWVudTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVja21lbnVDb250YWluc0R5YW5taWNDb250ZW50KHNpZGVtZW51QmxvY2tJZC5zdWJtZW51KTtcclxuICAgICAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICAgICAgc2lkZW1lbnVCbG9ja0lkLnN1Ym1lbnUgPSB0aGlzLmdsb2JhbE1lbnU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaWRlbWVudUJsb2NrID0gc2lkZW1lbnVCbG9ja0lkO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2lkZW1lbnVCbG9ja09uID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNpZGVCbG9ja0RhdGFSZXN1bHQgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVtZW51QmxvY2sgOiB0aGlzLnNpZGVtZW51QmxvY2ssXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGVtZW51QmxvY2tPbiA6IHRoaXMuc2lkZW1lbnVCbG9ja09uXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzaWRlQmxvY2tEYXRhUmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrbWVudUNvbnRhaW5zRHlhbm1pY0NvbnRlbnQobWVudSkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVudS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZihtZW51W2ldLnJlc3BvbnNlX2FwaV9rZXkgJiYgbWVudVtpXS5yZXNwb25zZV9hcGlfa2V5ICE9PSBcIlwiKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlbmV3TWVudShtZW51W2ldLCBtZW51W2ldLmxldmVsLCB0aGlzLmdsb2JhbE1lbnUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChtZW51W2ldLnN1Ym1lbnUgJiYgbWVudVtpXS5zdWJtZW51ID8ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja21lbnVDb250YWluc0R5YW5taWNDb250ZW50KG1lbnVbaV0uc3VibWVudSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhZGR5YW5taWNDb250ZW50KGFycmF5QWRkLCB0ZXh0LCBsZXZlbCwgZ2xvYmFsTWVudSkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2xvYmFsTWVudSA/Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmKGdsb2JhbE1lbnVbaV0ucmVzcG9uc2VfYXBpX2tleSAmJiBnbG9iYWxNZW51W2ldLnJlc3BvbnNlX2FwaV9rZXkgIT09IFwiXCIpe1xyXG4gICAgICAgICAgICAgICAgaWYoZ2xvYmFsTWVudVtpXS5saW5rVGV4dCA9PSB0ZXh0ICYmIGdsb2JhbE1lbnVbaV0ubGV2ZWwgPT0gbGV2ZWwpe1xyXG4gICAgICAgICAgICAgICAgICAgIGdsb2JhbE1lbnUuc3BsaWNlKGksIDEsIC4uLmFycmF5QWRkKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChnbG9iYWxNZW51W2ldLnN1Ym1lbnUgJiYgZ2xvYmFsTWVudVtpXS5zdWJtZW51ID8ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hZGR5YW5taWNDb250ZW50KGFycmF5QWRkLCB0ZXh0LCBsZXZlbCwgZ2xvYmFsTWVudVtpXS5zdWJtZW51KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ2xvYmFsTWVudSA9IGdsb2JhbE1lbnU7XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlbmV3TWVudShtZW51LCBsZXZlbCwgZ20pe1xyXG4gICAgICAgIGlmKG1lbnUgJiYgbWVudS5yZXNwb25zZV9hcGlfa2V5KXtcclxuICAgICAgICAgICAgbGV0IG5ld0FycmF5OiBhbnlbXSA9IFtdO1xyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2VLZXlzID0gbWVudS5yZXNwb25zZV9hcGlfa2V5LnNwbGl0KFwifHxcIik7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0Q3VycmVudFBhcmFtZXRlclZhbHVlKHJlc3BvbnNlS2V5cywgMSwgKTtcclxuICAgICAgICAgICAgbGV0IHBhcmFtZXRlclZhbHVlID0gdGhpcy5ibG9ja1NldHRlciA9PSB0cnVlID8gMSA6IDA7XHJcbiAgICAgICAgICAgIGxldCBhcGlEYXRhID0gdGhpcy5hcGlEYXRhU2VydmljZS5nZXRBcGlEYXRhQnlIYW5kbGVyKHJlc3BvbnNlS2V5c1twYXJhbWV0ZXJWYWx1ZV0uc3BsaXQoJyMjJylbMF0udHJpbSgpKTtcclxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlS2V5c1twYXJhbWV0ZXJWYWx1ZV0uaW5jbHVkZXMoJ1sqXScpICYmIGFwaURhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2V4ID0gcmVzcG9uc2VLZXlzW3BhcmFtZXRlclZhbHVlXS5zcGxpdCgnWypdJykuam9pbignXFxcXFtcXFxcZCtcXFxcXScpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGNvdW50ZXIgPSAwO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3ViTWVudVN0YXRpYyA9IG1lbnUuc3VibWVudTtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZGF0YUtleSBvZiBPYmplY3Qua2V5cyhhcGlEYXRhLnZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBuZXdNZW51OiBhbnkgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBkYXRhS2V5Lm1hdGNoKG5ldyBSZWdFeHAocmVnZXgpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIGFwaURhdGEudmFsdWVbZGF0YUtleV0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZ2V0bGV2ZWwgPSB0aGlzLmdldExldmVsQ2xhc3MobWVudS5sZXZlbCwgbWVudS5hdHRjaGVkbWVudUNsYXNzLCBjb3VudGVyLCBcIlwiLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGdldFN0YXRpYyA9IHRoaXMuc3RhdGljTWVudUFmdGVyRHluYW1pYyhzdWJNZW51U3RhdGljLCBnZXRsZXZlbCwgZ20pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgY2xvbmVkU3RhdGljID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShnZXRTdGF0aWMpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3TWVudS5saW5rVGV4dCA9IGFwaURhdGEudmFsdWVbZGF0YUtleV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01lbnUubWVudSA9IG1lbnUubWVudTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmV3TWVudS5hdHRjaGVkbWVudUNsYXNzID0gIGdldGxldmVsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvL25ld01lbnUuYXR0Y2hlZG1lbnVDbGFzcyA9ICBtZW51LmF0dGNoZWRtZW51Q2xhc3M7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01lbnUuYXR0Y2hlZG1lbnVDbGFzcyA9ICBtZW51LmF0dGNoZWRtZW51Q2xhc3MrIFwiX1wiICsgKGNvdW50ZXIgKyAxKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdNZW51LmF0dGFjaHRvU3RlcCA9IG1lbnUuYXR0YWNodG9TdGVwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdNZW51Lm1lbnVjbGFzcyA9IG1lbnUubWVudWNsYXNzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdNZW51LnJlc3BvbnNlX2FwaV9rZXkgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdNZW51LnN1Ym1lbnUgPSBtZW51LnN1Ym1lbnU/Lmxlbmd0aCA+IDAgPyBjbG9uZWRTdGF0aWMgOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3TWVudS5sZXZlbCA9IG1lbnUubGV2ZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld01lbnUubWVudV9jb25kaXRpb24gPSBtZW51Lm1lbnVfY29uZGl0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBcnJheS5wdXNoKG5ld01lbnUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudGVyKys7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5hZGR5YW5taWNDb250ZW50KG5ld0FycmF5LCBtZW51LmxpbmtUZXh0LCBsZXZlbCwgZ20pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBcclxuICAgIH1cclxuXHJcbiAgICBnZXRDdXJyZW50UGFyYW1ldGVyVmFsdWUocmVzcG9uc2VLZXlzLCBpKXtcclxuICAgICAgICBpZihyZXNwb25zZUtleXNbaV0pIHtcclxuICAgICAgICAgICAgbGV0IGFwaURhdGEgPSB0aGlzLmFwaURhdGFTZXJ2aWNlLmdldEFwaURhdGFCeUhhbmRsZXIocmVzcG9uc2VLZXlzW2ldLnNwbGl0KCcjIycpWzBdLnRyaW0oKSk7XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZUtleXNbaV0uaW5jbHVkZXMoJ1sqXScpICYmIGFwaURhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2V4ID0gcmVzcG9uc2VLZXlzW2ldLnNwbGl0KCdbKl0nKS5qb2luKCdcXFxcW1xcXFxkK1xcXFxdJyk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGRhdGFLZXkgb2YgT2JqZWN0LmtleXMoYXBpRGF0YS52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBkYXRhS2V5Lm1hdGNoKG5ldyBSZWdFeHAocmVnZXgpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICYmIGFwaURhdGEudmFsdWVbZGF0YUtleV0gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrU2V0dGVyID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljTWVudUFmdGVyRHluYW1pYyhtZW51LCBwYXJlbnRQb3NpdGlvbiwgZ20pe1xyXG4gICAgICAgIG1lbnUubWFwKCh4LCBpKSA9PntcclxuICAgICAgICAgICAgeC5hdHRjaGVkbWVudUNsYXNzID0gdGhpcy5nZXRMZXZlbENsYXNzKHgubGV2ZWwsIHguYXR0Y2hlZG1lbnVDbGFzcywgaSwgcGFyZW50UG9zaXRpb24sIDIpO1xyXG4gICAgICAgICAgICBpZih4LnJlc3BvbnNlX2FwaV9rZXkgJiYgeC5yZXNwb25zZV9hcGlfa2V5ICE9PSBcIlwiKXtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlbmV3TWVudSh4LCB4LmxldmVsLCBnbSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcmV0dXJuIG1lbnU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGV2ZWxDbGFzcyhtZW51TGV2ZWwsIG1lbnVQb3NpdGlvbiwgY291bnRlciwgcGFyZW50UG9zaXRpb24sIGJveCl7XHJcbiAgICAgICAgbGV0IHBhcmVudFBvc2l0aW9uQWRkO1xyXG4gICAgICAgIGxldCBjb250ZW50VmFsdWUgPVwiZHlcIjtcclxuICAgICAgICBpZihwYXJlbnRQb3NpdGlvbiAhPSBcIlwiKXtcclxuICAgICAgICAgICAgY29uc3QgcGFyZW50cGFydHMgPSBwYXJlbnRQb3NpdGlvbj8uc3BsaXQoJ18nKTtcclxuICAgICAgICAgICAgcGFyZW50UG9zaXRpb25BZGQgPSBOdW1iZXIocGFyZW50cGFydHNbcGFyZW50cGFydHMubGVuZ3RoIC0gMV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJ0cyA9IG1lbnVQb3NpdGlvbj8uc3BsaXQoJ18nKTtcclxuICAgICAgICBsZXQgbGFzdE51bWJlciA9IGJveCA9PSAxID8gTnVtYmVyKHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdKSArIE51bWJlcihjb3VudGVyKTogTnVtYmVyKGNvdW50ZXIpO1xyXG4gICAgICAgIGxldCBmaW5hbG1lbnVsZXZlbCA9IHBhcmVudFBvc2l0aW9uQWRkID8gdGhpcy5jcmVhdGVNZW51U3RyaW5nUmVjdXJzaXZlKG1lbnVMZXZlbCkrXCJfXCIrY29udGVudFZhbHVlK1wiX1wiK3BhcmVudFBvc2l0aW9uQWRkK1wiX1wiK2xhc3ROdW1iZXIgOiB0aGlzLmNyZWF0ZU1lbnVTdHJpbmdSZWN1cnNpdmUobWVudUxldmVsKSArXCJfXCIrY29udGVudFZhbHVlK1wiX1wiK2xhc3ROdW1iZXI7XHJcbiAgICAgICAgcmV0dXJuIGZpbmFsbWVudWxldmVsO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZU1lbnVTdHJpbmdSZWN1cnNpdmUobGV2ZWwpIHtcclxuICAgICAgICBpZiAobGV2ZWwgPT09IDEpIHtcclxuICAgICAgICByZXR1cm4gJ2xldmVsMSc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVNZW51U3RyaW5nUmVjdXJzaXZlKGxldmVsIC0gMSkgKyBgX2xldmVsJHtsZXZlbH1gO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn0iXX0=